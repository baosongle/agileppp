# 第6章笔记

看完这一章，感觉这是一次测试驱动开发和结对编程的实践

测试驱动开发（TDD），最重要的一项原则就是先编写测试代码，然后再去编写实现代码。但是，这究竟有什么好处呢？

1. **避免过度设计**。在书中的例子里，两个程序员要设计一个保龄球比赛计分系统，在还没有写出测试代码前，他们设计出了 `Frame` 类。后来在编写测试代码中，把 `Frame` 类删去了。作者认为这个类不带有任何逻辑，仅仅是 POJO，并没有存在的必要（Java Web 项目里，POJO 还是有意义的）
2. **逼迫模块作者从使用者的角度看待问题**。这是一个我之前经常犯的错误。在刚刚开始工作的几年里，leader 让我开发一个模块，我常常是在脑袋里想想这个类应当是怎样使用的，然后就编写接口和实现了。往往在最后时才发现接口的设计并不合理，整个代码需要重写一遍。我问 leader 该怎样解决这个问题，leader 只是说多写几年就不会犯这样的错误。现在的我看来，如果先写单元测试，我们能逼迫自己想使用者会怎样调用我们的模块、需要什么样的参数（要不要检查参数是 NULL、在哪一层检查 NULL）、给出什么样的返回值（返回 NULL 还是返回空对象）、抽象类的实现类该如何实例化（工厂模式、建造者模式）等等问题。不能只让自己写嗨了，让使用者感到别扭

但是在我们公司的项目里，单元测试覆盖的代码并不多，而且我也尝试加入一些测试代码，感觉并不容易，原因有下面几个

1. 项目代码太垃圾了。我们公司非常小，之前也没有做过程序开发项目，在一年内招了四个非计算机专业的学生，由一个 C 程序员带着开始做一个项目。一年多的时间里，我们用反设计模式的代码完成了项目。代码里各个模块交织在一起，甚至能在 Controller 中看到 sql 语句，不重构的话根本没法写测试，但是没测试又不敢进行大范围重构，只能一小部分一小部分来的改
2. 数据库依赖。似乎有数据库依赖的代码都不好做测试：你可以让测试代码连接真实的数据库，但是每次运行测试用例都会让数据库发生变化；也可以使用 mock 数据库的方式，但是要编写一大堆代码；比较理想的方法是使用 hsqldb，但偶尔会遇到与 mysql 或 oracle 不兼容的情况
3. 项目要求尽快交付。这就实在没办法了，写单元测试甚至要比写真实代码花费更多的时间。想写出覆盖率 100% 的代码真不是容易的事

一年前我就想在项目里实现 TDD，但是一直没什么进展。我们的项目是对内使用的，就算代码出错，也能通过其他方式补救；线上代码也算运行平稳，老板也不想进行大改；新的需求接踵而来，我只能尽量把新的代码写得好看。最让我烦恼的并不是我不能重构项目或是加入测试代码，而是在我做不到这些事的时候，没有人能够来教我，似乎加入新的公司是唯一的方法了

